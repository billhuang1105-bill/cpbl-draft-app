<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>選秀模擬器</title>
    <script>
        let team = null;
        let socket = null;
        let currentPosition = "";
        let currentPlayer = "";

        function connect() {
            team = document.getElementById("team").value;
            socket = new WebSocket(`ws://${location.host}/ws/${team}`);

            socket.onmessage = function(event) {
                const msg = JSON.parse(event.data);

                if (msg.type === "state") {
                    document.getElementById("status").textContent = msg.turn ? `輪到隊伍 ${msg.turn}` : "尚未開始";
                    document.getElementById("countdown").textContent = msg.countdown ? `倒數：${msg.countdown} 秒` : "";

                    // 更新球員選單
                    ["P", "C", "IF", "OF"].forEach(pos => {
                        const select = document.getElementById(`player_${pos}`);
                        select.innerHTML = "";
                        msg.available[pos].forEach(player => {
                            const opt = document.createElement("option");
                            opt.value = player;
                            opt.text = player;
                            select.appendChild(opt);
                        });
                    });

                    document.getElementById("teamAList").textContent = msg.teams["A"].join(", ");
                    document.getElementById("teamBList").textContent = msg.teams["B"].join(", ");
                }
            };
        }

        function addPlayers() {
            const positions = ["P", "C", "IF", "OF"];
            const playerData = {};
            positions.forEach(pos => {
                const names = document.getElementById(`input_${pos}`).value;
                playerData[pos] = names.split(",").map(x => x.trim()).filter(x => x);
            });
            socket.send(JSON.stringify({ type: "add_players", players: playerData }));
        }

        function startDraft() {
            socket.send(JSON.stringify({ type: "start_draft" }));
        }

        function resetDraft() {
            socket.send(JSON.stringify({ type: "reset" }));
        }

        function selectPlayer(pos) {
            currentPosition = pos;
            const select = document.getElementById(`player_${pos}`);
            currentPlayer = select.value;
            if (currentPlayer) {
                const confirmPick = confirm(`確定要選擇 ${currentPlayer} 嗎？`);
                if (confirmPick) {
                    socket.send(JSON.stringify({ type: "pick", position: currentPosition, player: currentPlayer }));
                }
            }
        }
    </script>
</head>
<body>
    <h2>CPBL 雙人選秀模擬器</h2>

    <label>請選擇你的隊伍：</label>
    <select id="team">
        <option value="A">A</option>
        <option value="B">B</option>
    </select>
    <button onclick="connect()">連線</button>

    <hr>

    <div id="controls_A" style="display: block;">
        <h3>球員名單輸入（僅限 A 隊）</h3>
        <label>P：<input id="input_P" type="text" placeholder="用逗號分隔，如 王大明,李小明"></label><br>
        <label>C：<input id="input_C" type="text"></label><br>
        <label>IF：<input id="input_IF" type="text"></label><br>
        <label>OF：<input id="input_OF" type="text"></label><br>
        <button onclick="addPlayers()">送出名單</button>
        <button onclick="startDraft()">開始選秀</button>
        <button onclick="resetDraft()">重設</button>
    </div>

    <hr>

    <div>
        <h3>選擇球員</h3>
        <label>P：
            <select id="player_P"></select>
            <button onclick="selectPlayer('P')">選擇</button>
        </label><br>
        <label>C：
            <select id="player_C"></select>
            <button onclick="selectPlayer('C')">選擇</button>
        </label><br>
        <label>IF：
            <select id="player_IF"></select>
            <button onclick="selectPlayer('IF')">選擇</button>
        </label><br>
        <label>OF：
            <select id="player_OF"></select>
            <button onclick="selectPlayer('OF')">選擇</button>
        </label>
    </div>

    <hr>

    <div>
        <p id="status">尚未開始</p>
        <p id="countdown"></p>
    </div>

    <div>
        <h4>A 隊選秀結果：</h4>
        <p id="teamAList"></p>
        <h4>B 隊選秀結果：</h4>
        <p id="teamBList"></p>
    </div>
</body>
</html>
