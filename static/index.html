<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>中職選秀模擬器</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    input, button, select {
      margin: 5px;
    }
    .team-box {
      display: inline-block;
      vertical-align: top;
      width: 45%;
      min-height: 150px;
      background: white;
      padding: 10px;
      margin: 10px;
      border-radius: 5px;
    }
    .player-button {
      margin: 3px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h2>1. 輸入球員名單（選秀前）</h2>
  <div>
    P：<input id="P" />
    <br />
    C：<input id="C" />
    <br />
    IF：<input id="IF" />
    <br />
    OF：<input id="OF" />
    <br />
    <button onclick="sendPlayerList()">送出名單</button>
    <button onclick="startDraft()">開始選秀</button>
    <button onclick="reset()">重置</button>
  </div>

  <h2>2. 開始選秀</h2>
  <p>目前輪到：<span id="turn">-</span></p>
  <p>選擇守備位置：
    <button onclick="selectPosition('P')">P</button>
    <button onclick="selectPosition('C')">C</button>
    <button onclick="selectPosition('IF')">IF</button>
    <button onclick="selectPosition('OF')">OF</button>
  </p>

  <div id="players"></div>

  <div class="team-box">
    <h3>球隊 A</h3>
    <div id="teamA"></div>
  </div>
  <div class="team-box">
    <h3>球隊 B</h3>
    <div id="teamB"></div>
  </div>

  <script>
    const ws = new WebSocket(`wss://${window.location.host}/ws`);
    let selectedPosition = null;
    let currentTeam = "A";

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "state") {
        document.getElementById("turn").innerText = msg.turn;
        currentTeam = msg.turn;
        updateTeams(msg.teams);
        updateAvailable(msg.available);
        if (msg.finished) {
          alert("選秀結束！");
        }
      }
    };

    function sendPlayerList() {
      const data = {
        type: "add_players",
        players: {
          P: document.getElementById("P").value.split("、"),
          C: document.getElementById("C").value.split("、"),
          IF: document.getElementById("IF").value.split("、"),
          OF: document.getElementById("OF").value.split("、"),
        }
      };
      ws.send(JSON.stringify(data));
    }

    function startDraft() {
      ws.send(JSON.stringify({ type: "start_draft" }));
    }

    function reset() {
      ws.send(JSON.stringify({ type: "reset" }));
    }

    function selectPosition(pos) {
      selectedPosition = pos;
      updateAvailableDisplay(pos);
    }

    function updateTeams(teams) {
      document.getElementById("teamA").innerText = teams.A.join("、");
      document.getElementById("teamB").innerText = teams.B.join("、");
    }

    function updateAvailable(availableList) {
      window.availablePlayers = availableList;
      if (selectedPosition) {
        updateAvailableDisplay(selectedPosition);
      }
    }

    function updateAvailableDisplay(pos) {
      const players = window.availablePlayers[pos] || [];
      const container = document.getElementById("players");
      container.innerHTML = `<h4>${pos} 可選球員</h4>`;
      players.forEach(p => {
        const btn = document.createElement("button");
        btn.innerText = p;
        btn.className = "player-button";
        btn.onclick = () => {
          if (confirm(`確定選擇 ${p} 嗎？`)) {
            ws.send(JSON.stringify({ type: "pick", team: currentTeam, position: pos, player: p }));
          }
        };
        container.appendChild(btn);
      });
    }
  </script>
</body>
</html>
