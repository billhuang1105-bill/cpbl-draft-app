<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Draft Simulator</title>
  <script>
    let ws;
    let team = prompt("請輸入你的隊伍代號 (A 或 B)").toUpperCase();
    if (team !== "A" && team !== "B") {
      alert("代號錯誤，請重新整理頁面並輸入 A 或 B");
    }

    const players = { P: [], C: [], IF: [], OF: [] };
    let currentPosition = "P";
    let availablePlayers = {};
    let currentTurn = null;
    let countdown = 0;

    function setupWebSocket() {
      ws = new WebSocket(`ws://${location.host}/ws/${team}`);

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === "state") {
          availablePlayers = msg.available;
          currentTurn = msg.turn;
          countdown = msg.countdown;
          updateUI(msg);
        }
      };
    }

    function updateUI(msg) {
      document.getElementById("teams").innerText =
        `A: ${msg.teams.A.join(", ")}\nB: ${msg.teams.B.join(", ")}`;
      document.getElementById("countdown").innerText =
        msg.turn ? `目前輪到 ${msg.turn} 隊選擇 (${countdown}s)` : "等待開始";
      updatePlayerOptions();
    }

    function updatePlayerOptions() {
      const select = document.getElementById("player");
      select.innerHTML = "";
      for (const name of availablePlayers[currentPosition] || []) {
        const option = document.createElement("option");
        option.value = name;
        option.innerText = name;
        select.appendChild(option);
      }
    }

    function submitPlayers() {
      for (const pos of ["P", "C", "IF", "OF"]) {
        const names = document.getElementById(pos).value.split(",").map(x => x.trim());
        players[pos] = names;
      }
      ws.send(JSON.stringify({ type: "add_players", players }));
    }

    function startDraft() {
      ws.send(JSON.stringify({ type: "start_draft" }));
    }

    function pickPlayer() {
      if (currentTurn !== team) {
        alert("尚未輪到你選擇");
        return;
      }
      const player = document.getElementById("player").value;
      if (confirm(`你確定要選擇 ${player} 嗎？`)) {
        ws.send(JSON.stringify({ type: "pick", position: currentPosition, player }));
      }
    }

    function changePosition(pos) {
      currentPosition = pos;
      updatePlayerOptions();
    }

    function resetDraft() {
      ws.send(JSON.stringify({ type: "reset" }));
    }

    window.onload = setupWebSocket;
  </script>
</head>
<body>
  <h1>選秀模擬器</h1>
  <div id="setup" style="display: inline-block; vertical-align: top;">
    <h3>輸入選手名單 (僅 A 隊可填)</h3>
    <p>P: <input id="P" placeholder="如 張三,李四"></p>
    <p>C: <input id="C"></p>
    <p>IF: <input id="IF"></p>
    <p>OF: <input id="OF"></p>
    <button onclick="submitPlayers()">提交選手</button>
    <button onclick="startDraft()">開始選秀</button>
    <button onclick="resetDraft()">重置</button>
  </div>

  <div style="display: inline-block; margin-left: 50px;">
    <h3>選擇球員</h3>
    <div>
      <button onclick="changePosition('P')">P</button>
      <button onclick="changePosition('C')">C</button>
      <button onclick="changePosition('IF')">IF</button>
      <button onclick="changePosition('OF')">OF</button>
    </div>
    <select id="player"></select>
    <button onclick="pickPlayer()">選擇球員</button>
    <p id="countdown"></p>
    <pre id="teams"></pre>
  </div>
</body>
</html>
