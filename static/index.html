<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>雙人選秀模擬器</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        textarea, select, button { margin: 5px; }
        #countdown { font-weight: bold; color: red; }
    </style>
</head>
<body>
    <h2>雙人選秀模擬器</h2>
    <div>
        <label>請選擇隊伍：</label>
        <button onclick="selectTeam('A')">隊伍 A</button>
        <button onclick="selectTeam('B')">隊伍 B</button>
    </div>

    <div id="inputArea" style="display:none;">
        <h3>輸入選手名單（每個位置一行一位）</h3>
        <textarea id="P" rows="3" cols="30" placeholder="投手 P"></textarea><br>
        <textarea id="C" rows="3" cols="30" placeholder="捕手 C"></textarea><br>
        <textarea id="IF" rows="3" cols="30" placeholder="內野 IF"></textarea><br>
        <textarea id="OF" rows="3" cols="30" placeholder="外野 OF"></textarea><br>
        <button onclick="sendPlayers()">送出名單</button>
        <button onclick="startDraft()">開始選秀</button>
        <button onclick="resetDraft()">重新開始</button>
    </div>

    <div id="draftArea" style="display:none;">
        <h3>目前輪到：<span id="currentTurn">-</span></h3>
        <p>倒數：<span id="countdown">-</span> 秒</p>
        <label>選擇守備位置：</label>
        <select id="positionSelect" onchange="updatePlayerOptions()">
            <option value="P">P</option>
            <option value="C">C</option>
            <option value="IF">IF</option>
            <option value="OF">OF</option>
        </select>
        <label>選擇球員：</label>
        <select id="playerSelect"></select>
        <button onclick="pickPlayer()">選擇</button>
        <hr>
        <h4>隊伍 A：</h4>
        <ul id="teamA"></ul>
        <h4>隊伍 B：</h4>
        <ul id="teamB"></ul>
    </div>

    <script>
        let team = null;
        let ws = null;
        let available = {};

        function selectTeam(selectedTeam) {
            team = selectedTeam;
            ws = new WebSocket(`ws://${location.host}/ws/${team}`);
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === "state") {
                    document.getElementById("currentTurn").innerText = msg.turn || "-";
                    document.getElementById("countdown").innerText = msg.countdown ?? "-";
                    updateTeamList("A", msg.teams.A);
                    updateTeamList("B", msg.teams.B);
                    available = msg.available;
                    updatePlayerOptions();

                    if (!msg.turn && team === "A") {
                        document.getElementById("inputArea").style.display = "block";
                    } else {
                        document.getElementById("inputArea").style.display = "none";
                        document.getElementById("draftArea").style.display = "block";
                    }
                }
            };
        }

        function updateTeamList(teamId, players) {
            const ul = document.getElementById("team" + teamId);
            ul.innerHTML = "";
            players.forEach(p => {
                const li = document.createElement("li");
                li.innerText = p;
                ul.appendChild(li);
            });
        }

        function sendPlayers() {
            const positions = ["P", "C", "IF", "OF"];
            const data = { type: "add_players", players: {} };
            positions.forEach(pos => {
                const lines = document.getElementById(pos).value.split("\n").map(s => s.trim()).filter(Boolean);
                data.players[pos] = lines;
            });
            ws.send(JSON.stringify(data));
        }

        function startDraft() {
            ws.send(JSON.stringify({ type: "start_draft" }));
        }

        function resetDraft() {
            ws.send(JSON.stringify({ type: "reset" }));
        }

        function updatePlayerOptions() {
            const pos = document.getElementById("positionSelect").value;
            const select = document.getElementById("playerSelect");
            select.innerHTML = "";
            (available[pos] || []).forEach(p => {
                const option = document.createElement("option");
                option.value = option.text = p;
                select.appendChild(option);
            });
        }

        function pickPlayer() {
            const pos = document.getElementById("positionSelect").value;
            const player = document.getElementById("playerSelect").value;
            ws.send(JSON.stringify({ type: "pick", position: pos, player: player }));
        }
    </script>
</body>
</html>
