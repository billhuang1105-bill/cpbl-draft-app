<!DOCTYPE html>
<html>
<head>
    <title>雙人選秀模擬器</title>
    <meta charset="utf-8">
    <script>
        let ws = null;
        let team = null;
        let state = {};
        let connected = false;

        function connectWebSocket(selectedTeam) {
            if (connected) return;
            team = selectedTeam;
            const protocol = location.protocol === "https:" ? "wss" : "ws";
            ws = new WebSocket(`${protocol}://${location.host}/ws/${team}`);
            connected = true;

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "state") {
                    state = data;
                    updateUI();
                }
            };

            ws.onopen = () => {
                document.getElementById("status").innerText = `已連線：隊伍 ${team}`;
                if (team !== 'A') {
                    document.getElementById("input_section").style.display = "none";
                }
            };

            ws.onerror = (err) => {
                console.error("WebSocket error", err);
            };
        }

        function send(type, payload = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type, ...payload }));
            }
        }

        function addPlayers() {
            const positions = ["P", "C", "IF", "OF"];
            const players = {};
            for (let pos of positions) {
                const input = document.getElementById(`input_${pos}`).value.trim();
                players[pos] = input ? input.split("\n") : [];
            }
            send("add_players", { players });
        }

        function startDraft() {
            send("start_draft");
        }

        function resetDraft() {
            send("reset");
        }

        function pickPlayer() {
            const pos = document.getElementById("select_position").value;
            const player = document.getElementById("select_player").value;
            if (confirm(`確定要選擇 ${player} 嗎？`)) {
                send("pick", { position: pos, player });
            }
        }

        function updateUI() {
            document.getElementById("team_turn").innerText = `目前輪到：${state.turn || "-"}`;
            document.getElementById("countdown").innerText = `倒數：${state.countdown || 0} 秒`;

            const select = document.getElementById("select_player");
            const pos = document.getElementById("select_position").value;
            select.innerHTML = "";
            if (state.available && state.available[pos]) {
                for (let player of state.available[pos]) {
                    const option = document.createElement("option");
                    option.text = player;
                    option.value = player;
                    select.appendChild(option);
                }
            }

            for (let teamKey of ["A", "B"]) {
                const list = document.getElementById(`team_${teamKey}_list`);
                list.innerHTML = "";
                for (let player of state.teams?.[teamKey] || []) {
                    const li = document.createElement("li");
                    li.innerText = player;
                    list.appendChild(li);
                }
            }
        }

        function onPositionChange() {
            updateUI();
        }
    </script>
</head>
<body>
    <h2>雙人選秀模擬器</h2>
    <div>
        <label>請選擇隊伍：</label>
        <button onclick="connectWebSocket('A')">隊伍 A</button>
        <button onclick="connectWebSocket('B')">隊伍 B</button>
        <span id="status">尚未連線</span>
    </div>

    <div id="input_section">
        <hr>
        <h3>輸入選手名單（每個位置一行一位）</h3>
        <textarea id="input_P" placeholder="投手 P" rows="3" cols="30"></textarea><br>
        <textarea id="input_C" placeholder="捕手 C" rows="3" cols="30"></textarea><br>
        <textarea id="input_IF" placeholder="內野 IF" rows="3" cols="30"></textarea><br>
        <textarea id="input_OF" placeholder="外野 OF" rows="3" cols="30"></textarea><br>
        <button onclick="addPlayers()">送出名單</button>
        <button onclick="startDraft()">開始選秀</button>
        <button onclick="resetDraft()">重新開始</button>
    </div>

    <hr>

    <h3 id="team_turn">目前輪到：</h3>
    <div id="countdown">倒數：</div>

    <label>選擇位置：</label>
    <select id="select_position" onchange="onPositionChange()">
        <option value="P">P</option>
        <option value="C">C</option>
        <option value="IF">IF</option>
        <option value="OF">OF</option>
    </select>

    <label>選擇球員：</label>
    <select id="select_player"></select>

    <button onclick="pickPlayer()">選擇</button>

    <hr>

    <h3>隊伍 A</h3>
    <ul id="team_A_list"></ul>
    <h3>隊伍 B</h3>
    <ul id="team_B_list"></ul>
</body>
</html>
